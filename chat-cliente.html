<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat do Chamado - WG Inform√°tica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #0a181c; /* Fundo escuro para o chat */
        }
        .chat-bg {
            background-image: url('https://i.pinimg.com/736x/8c/98/99/8c98994518b575bfd8c949e91d20548b.jpg');
            background-repeat: repeat;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
</head>
<body class="flex flex-col h-screen">

    <header class="bg-slate-800 shadow-md text-white p-4 flex items-center justify-between">
        <div>
            <h1 class="text-lg font-bold">Chat do Chamado</h1>
            <p id="info-chamado" class="text-xs text-slate-300">Carregando...</p>
        </div>
        <a href="cliente.html" class="text-sm text-teal-400 hover:text-teal-300">‚Üê Voltar</a>
    </header>

    <main class="flex-1 overflow-y-auto p-4 chat-bg">
        <div id="chat" class="space-y-4">
            <!-- As mensagens ser√£o inseridas aqui -->
        </div>
    </main>

    <footer class="bg-slate-800 p-2">
        <div class="flex items-center gap-2">
            <textarea id="mensagem" placeholder="Digite sua mensagem..." class="w-full p-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-teal-500 resize-none" rows="1" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';"></textarea>
            <button onclick="enviarMensagem()" class="bg-teal-600 text-white rounded-full p-3 hover:bg-teal-500 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
    </footer>
    
    <!-- Iframe para envio de e-mail silencioso -->
    <iframe name="gas_silent" style="display:none"></iframe>

    <script>
        const db = firebase.firestore();
        const auth = firebase.auth();
        const params = new URLSearchParams(window.location.search);
        const chamadoId = params.get("id");
        let currentUserEmail = null;

        auth.onAuthStateChanged(user => {
            if (!user || !chamadoId) {
                window.location.href = "login-cliente.html";
                return;
            }
            currentUserEmail = user.email;

            db.collection("chamados").doc(chamadoId).get().then(doc => {
                if (doc.exists) {
                    const chamado = doc.data();
                    document.getElementById("info-chamado").textContent = `Chamado #${doc.id.substring(0,6)} - ${chamado.empresa || 'Cliente'}`;
                }
            });

            db.collection("chamados").doc(chamadoId).collection("mensagens")
              .orderBy("data")
              .onSnapshot(snapshot => {
                  const chat = document.getElementById("chat");
                  chat.innerHTML = "";
                  snapshot.forEach(doc => {
                      const msg = doc.data();
                      const isSelf = msg.usuario === currentUserEmail;
                      const dataMsg = msg.data ? msg.data.toDate() : new Date();
                      const horaFormatada = dataMsg.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                      
                      const div = document.createElement("div");
                      div.className = `flex ${isSelf ? 'justify-end' : 'justify-start'}`;
                      div.innerHTML = `
                          <div class="max-w-xs md:max-w-md p-3 rounded-lg shadow-md ${isSelf ? 'bg-teal-800 text-white' : 'bg-slate-600 text-white'}">
                              <p class="text-xs font-bold mb-1 ${isSelf ? 'text-teal-200' : 'text-slate-300'}">${msg.usuario}</p>
                              <p class="text-sm">${msg.texto}</p>
                              <p class="text-xs text-right mt-1 ${isSelf ? 'text-teal-300' : 'text-slate-400'}">${horaFormatada}</p>
                          </div>
                      `;
                      chat.appendChild(div);
                  });
                  chat.parentElement.scrollTop = chat.parentElement.scrollHeight;
              });
        });

        async function enviarMensagem() {
            const texto = document.getElementById("mensagem").value;
            if (texto.trim() === "" || !currentUserEmail) return;

            await db.collection("chamados").doc(chamadoId).collection("mensagens").add({
                texto: texto,
                usuario: currentUserEmail,
                data: firebase.firestore.FieldValue.serverTimestamp()
            });

            // === DISPARO DE E-MAIL SILENCIOSO (cliente -> t√©cnicos/admin) ===
            try {
                const base = location.origin;
                enviarEmailSilencioso({
                    para: EMAILS_TECNICOS.join(','),
                    cc:   EMAILS_ADMIN.join(','),
                    assunto: `üí¨ Nova mensagem no chat do chamado #${chamadoId.slice(0,6).toUpperCase()}`,
                    html: montarHtmlMsgChat({
                        autor: currentUserEmail,
                        papel: 'Cliente',
                        msg: texto,
                        linkChat: `${base}/chat-cliente.html?id=${chamadoId}`,
                        idChamado: chamadoId
                    })
                });
            } catch(e){
                console.error('Falha ao disparar e-mail de chat (cliente):', e);
            }

            document.getElementById("mensagem").value = "";
            document.getElementById("mensagem").style.height = 'auto'; // Reset height
        }

        document.getElementById('mensagem').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                enviarMensagem();
            }
        });

        // ====== BLOCO COMUM: e-mail silencioso (anti-CORS) ======
        const GAS_URL = "https://script.google.com/macros/s/AKfycbz2U9j696QVojXt00lnsfcLO2rUgDA8AptLlTbPsRuAO8KrrOCDpHE-Cx8FYMeXf4F86A/exec";
        const GAS_SECRET = "!Plokij789";

        const EMAILS_TECNICOS = [
            "xoenfalos2014@gmail.com",
            "kassyo@suporteworkgroup.com.br",
            "malaquias@suporteworkgroup.com.br",
            "rlkbubu70@gmail.com"
        ];
        const EMAILS_ADMIN = [
            "xoenfalos2014@gmail.com",
            "kassyo@suporteworkgroup.com.br"
        ];

        function enviarEmailSilencioso({ para, cc, assunto, html, replyTo, nomeRemetente="WG Inform√°tica" }) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `${GAS_URL}?token=${encodeURIComponent(GAS_SECRET)}`;
            form.target = 'gas_silent';
            form.style.display = 'none';

            const fields = { para, cc, assunto, html, replyTo, nomeRemetente };
            Object.entries(fields).forEach(([k,v])=>{
                if (!v) return;
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = k;
                input.value = v;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
            setTimeout(()=> { try { form.remove(); } catch(e) {} }, 2000);
        }

        function esc(s){ return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
        function nl2br(s){ return (s||'').replace(/\n/g,'<br>'); }
        function pad(n){ return n<10?'0'+n:n; }
        function agoraBR(){
            const d = new Date();
            return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }
        function montarHtmlMsgChat({autor, papel, msg, linkChat, idChamado}){
            return `
                <div style="font:14px Arial,Helvetica,sans-serif">
                    <h2 style="margin:0 0 8px">Nova mensagem no chat</h2>
                    <p><b>Chamado:</b> ${esc(idChamado)}</p>
                    <p><b>Remetente:</b> ${esc(autor)} (${esc(papel)})</p>
                    <p><b>Mensagem:</b><br>${nl2br(esc(msg))}</p>
                    <p><b>Quando:</b> ${agoraBR()}</p>
                    <hr>
                    <p><a href="${esc(linkChat)}" target="_blank">Abrir chat agora</a></p>
                    <p style="color:#777">WG Inform√°tica ‚Ä¢ Notifica√ß√£o autom√°tica</p>
                </div>`;
        }
    </script>
</body>
</html>

