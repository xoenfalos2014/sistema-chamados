
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Chat TÃ©cnico</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
</head>
<body>
  <h2>Chat com Cliente</h2>
  <div id="chat" style="margin-bottom: 20px;"></div>

  <textarea id="mensagem" placeholder="Digite sua mensagem"></textarea>
  <button onclick="enviarMensagem()">Enviar</button>

  <script>
    const db = firebase.firestore();
    const auth = firebase.auth();
    const params = new URLSearchParams(window.location.search);
    const chamadoId = params.get("id");

    auth.onAuthStateChanged(user => {
      if (!user || !chamadoId) return location.href = "login-tecnico.html";

      db.collection("chamados").doc(chamadoId).collection("mensagens")
        .orderBy("data")
        .onSnapshot(snapshot => {
          const chat = document.getElementById("chat");
          chat.innerHTML = "";
          snapshot.forEach(doc => {
            const msg = doc.data();
            const div = document.createElement("div");
            div.innerHTML = `<b>${msg.usuario}:</b> ${msg.texto}`;
            chat.appendChild(div);
          });
        });
    });

    function enviarMensagem() {
      const texto = document.getElementById("mensagem").value;
      const user = firebase.auth().currentUser;
      if (texto.trim() === "" || !user) return;

      db.collection("chamados").doc(chamadoId).collection("mensagens").add({
        texto: texto,
        usuario: user.email,
        data: new Date()
      });

      document.getElementById("mensagem").value = "";
    }
  </script>
</body>
</html>
