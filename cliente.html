<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Área do Cliente</title>
  <link rel="stylesheet" href="css/style.css">

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
</head>
<body>
  <div class="container">
    <h2>Abertura de Chamado</h2>
    <form id="form-chamado" class="form">
      <input id="nome" placeholder="Seu nome" required class="input">
      <input id="email" placeholder="Seu e-mail" required class="input">
      <input id="empresa" placeholder="Empresa" required class="input">
      <input id="setor" placeholder="Setor" required class="input">
      <textarea id="mensagem" placeholder="Descreva o problema" required class="input"></textarea>
      <button type="submit" class="btn btn-green">Enviar Chamado</button>
    </form>

    <h3>Seus Chamados</h3>
    <div id="lista-chamados" class="lista">Carregando...</div>
  </div>

  <script>
    const db = firebase.firestore();
    const auth = firebase.auth();

    auth.onAuthStateChanged(user => {
      if (!user) return location.href = "login-cliente.html";

      const uid = user.uid;

      db.collection("chamados").where("usuarioId", "==", uid)
        .orderBy("criadoEm", "desc")
        .onSnapshot(snapshot => {
          const lista = document.getElementById("lista-chamados");
          lista.innerHTML = "";
          if (snapshot.empty) {
            lista.innerHTML = "<p>Você ainda não abriu chamados.</p>";
          } else {
            snapshot.forEach(doc => {
              const c = doc.data();
              const criadoEm = formatarData(c.criadoEm);
              lista.innerHTML += `
                <div class="chamado-card">
                  <p>⏰ Aberto em: ${criadoEm}</p>
                  <p><strong>${c.status}</strong> - ${c.mensagem}</p>
                  <button onclick="window.location.href='chat-cliente.html?id=${doc.id}'" class="btn btn-dark">Abrir Chat</button>
                </div>
              `;
            });
          }
        });

      document.getElementById("form-chamado").addEventListener("submit", async e => {
        e.preventDefault();

        const nome = document.getElementById("nome").value;
        const email = document.getElementById("email").value;
        const empresa = document.getElementById("empresa").value;
        const setor = document.getElementById("setor").value;
        const mensagem = document.getElementById("mensagem").value;

        const docRef = await db.collection("chamados").add({
          nome, email, empresa, setor, mensagem,
          usuarioId: uid,
          status: "Aberto",
          criadoEm: new Date()
        });

        window.location.href = "chat-cliente.html?id=" + docRef.id;
      });
    });

    function formatarData(dataFirestore) {
      if (!dataFirestore || !dataFirestore.toDate) return "";
      const data = dataFirestore.toDate();
      const dia = String(data.getDate()).padStart(2, '0');
      const mes = String(data.getMonth() + 1).padStart(2, '0');
      const ano = data.getFullYear();
      const hora = String(data.getHours()).padStart(2, '0');
      const min = String(data.getMinutes()).padStart(2, '0');
      return `${dia}/${mes}/${ano} ${hora}:${min}`;
    }
  </script>
</body>
</html>
