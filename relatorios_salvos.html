<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios Salvos - WG Inform√°tica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen">

    <header class="bg-slate-800 shadow-md">
        <div class="max-w-5xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">üìÇ Relat√≥rios Salvos</h1>
            <a href="tecnico.html" class="text-sm text-teal-400 hover:text-teal-300">‚Üê Voltar ao Painel</a>
        </div>
    </header>

    <main class="max-w-5xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="bg-slate-800 rounded-2xl shadow-2xl p-6 border border-slate-700">
            <!-- Filtros -->
            <div class="flex flex-col sm:flex-row gap-4 mb-6 items-center">
                <input id="filtroCliente" type="text" placeholder="Filtrar por cliente..." class="flex-grow w-full p-2 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-teal-500">
                <input id="filtroDataInicio" type="date" class="p-2 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-teal-500">
                <input id="filtroDataFim" type="date" class="p-2 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-teal-500">
                <button onclick="carregarRelatorios()" class="w-full sm:w-auto bg-teal-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-teal-500 transition-colors">üîç Buscar</button>
            </div>

            <!-- Lista de Relat√≥rios -->
            <div id="listaRelatorios" class="space-y-4"></div>
        </div>
    </main>

    <script>
        const db = firebase.firestore();
        const auth = firebase.auth();

        auth.onAuthStateChanged(user => {
            if (!user) return location.href = "login-tecnico.html";
            carregarRelatorios();
        });

        async function carregarRelatorios() {
            const lista = document.getElementById("listaRelatorios");
            lista.innerHTML = "<p class='text-center text-slate-400'>Carregando relat√≥rios...</p>";

            const clienteFiltro = document.getElementById("filtroCliente").value.toLowerCase();
            const dataInicio = document.getElementById("filtroDataInicio").value;
            const dataFim = document.getElementById("filtroDataFim").value;

            let query = db.collection("relatorios_tecnicos").orderBy("criadoEm", "desc");

            if (dataInicio) {
                query = query.where("criadoEm", ">=", new Date(dataInicio + 'T00:00:00'));
            }
            if (dataFim) {
                const fim = new Date(dataFim + 'T23:59:59');
                query = query.where("criadoEm", "<=", fim);
            }

            try {
                const snapshot = await query.get();
                const relatoriosFiltrados = [];

                if (snapshot.empty) {
                    lista.innerHTML = "<div class='text-center p-8 bg-slate-700/50 rounded-lg'><p class='text-slate-400'>Nenhum relat√≥rio encontrado para os filtros aplicados.</p></div>";
                    return;
                }

                snapshot.forEach(doc => {
                    const r = doc.data();
                    if (clienteFiltro && !r.cliente.toLowerCase().includes(clienteFiltro)) {
                        return;
                    }
                    relatoriosFiltrados.push(r);
                });

                if (relatoriosFiltrados.length === 0) {
                     lista.innerHTML = "<div class='text-center p-8 bg-slate-700/50 rounded-lg'><p class='text-slate-400'>Nenhum relat√≥rio encontrado para o cliente informado.</p></div>";
                    return;
                }

                lista.innerHTML = ""; // Limpa o "Carregando"
                relatoriosFiltrados.forEach(r => {
                    const dataFormatada = r.criadoEm?.toDate().toLocaleString("pt-BR") || "Data indispon√≠vel";
                    const dataInput = r.data || '';

                    const item = document.createElement("div");
                    item.className = "bg-slate-700 p-4 rounded-lg shadow-md border border-slate-600";

                    item.innerHTML = `
                        <div class="flex justify-between items-start">
                            <p class="font-bold text-lg text-white">${r.cliente}</p>
                            <span class="text-xs text-slate-400">${dataFormatada}</span>
                        </div>
                        <div class="mt-3 space-y-2">
                            <p><strong class="text-teal-400">Data do Servi√ßo:</strong> <span class="text-slate-300">${new Date(dataInput + 'T00:00:00').toLocaleDateString('pt-BR')}</span></p>
                            <p><strong class="text-teal-400">Servi√ßo:</strong> <span class="text-slate-300">${r.servico}</span></p>
                            ${r.observacoes ? `<p><strong class="text-teal-400">Observa√ß√µes:</strong> <span class="text-slate-300">${r.observacoes}</span></p>` : ''}
                        </div>
                        <div class="mt-4">
                            <button onclick='enviarWhatsapp(${JSON.stringify({
                                cliente: r.cliente,
                                data: new Date(dataInput + 'T00:00:00').toLocaleDateString('pt-BR'),
                                servico: r.servico,
                                observacoes: r.observacoes || "",
                                tecnico: r.tecnico || ""
                            })})' class='bg-green-600 text-white font-semibold text-sm py-1 px-3 rounded-md hover:bg-green-500 transition-colors'>üì§ Enviar por WhatsApp</button>
                        </div>
                    `;

                    lista.appendChild(item);
                });

            } catch(error) {
                console.error("Erro ao carregar relat√≥rios:", error);
                lista.innerHTML = "<div class='text-center p-8 bg-red-900/50 rounded-lg'><p class='text-red-300'>Ocorreu um erro ao buscar os relat√≥rios. Verifique o console para mais detalhes.</p></div>";
            }
        }

        function enviarWhatsapp(relatorio) {
            const mensagem = `*RELAT√ìRIO T√âCNICO*\n\n*Cliente:* ${relatorio.cliente}\n*Data:* ${relatorio.data}\n*T√©cnico:* ${relatorio.tecnico}\n\n*Servi√ßo Executado:*\n${relatorio.servico}\n\n*Observa√ß√µes:*\n${relatorio.observacoes}`.trim();

            const numero = prompt("Digite o n√∫mero do WhatsApp do cliente com DDD (ex: 21999999999):");
            if (numero && numero.match(/^\d{10,11}$/)) {
                 const url = `https://wa.me/55${numero}?text=${encodeURIComponent(mensagem)}`;
                window.open(url, "_blank");
            } else if (numero) {
                alert("N√∫mero de telefone inv√°lido. Por favor, insira apenas os n√∫meros, incluindo o DDD.");
            }
        }

        // Tornar a fun√ß√£o globalmente acess√≠vel para o onclick
        window.enviarWhatsapp = enviarWhatsapp;
        window.carregarRelatorios = carregarRelatorios;

    </script>
</body>
</html>
