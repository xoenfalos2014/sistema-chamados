
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>RelatÃ³rios TÃ©cnicos</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="js/firebase-config.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-5xl mx-auto bg-white rounded-lg shadow p-6">
    <h1 class="text-2xl font-bold mb-4">ğŸ“‚ RelatÃ³rios TÃ©cnicos Salvos</h1>

    <div class="flex gap-4 mb-4 flex-wrap">
      <input id="filtroCliente" type="text" placeholder="Filtrar por cliente" class="border p-2 rounded w-full sm:w-auto flex-1">
      <input id="filtroDataInicio" type="date" class="border p-2 rounded">
      <input id="filtroDataFim" type="date" class="border p-2 rounded">
      <button onclick="carregarRelatorios()" class="bg-blue-600 text-white px-4 py-2 rounded">ğŸ” Buscar</button>
    </div>

    <div id="listaRelatorios" class="space-y-4"></div>
  </div>

  <script>
    const db = firebase.firestore();
    const auth = firebase.auth();

    auth.onAuthStateChanged(user => {
      if (!user) return location.href = "login-tecnico.html";
      carregarRelatorios();
    });

    async function carregarRelatorios() {
      const lista = document.getElementById("listaRelatorios");
      lista.innerHTML = "<p>Carregando...</p>";

      const clienteFiltro = document.getElementById("filtroCliente").value.toLowerCase();
      const dataInicio = document.getElementById("filtroDataInicio").value;
      const dataFim = document.getElementById("filtroDataFim").value;

      let query = db.collection("relatorios_tecnicos").orderBy("criadoEm", "desc");

      if (dataInicio) query = query.where("criadoEm", ">=", new Date(dataInicio));
      if (dataFim) {
        const fim = new Date(dataFim);
        fim.setHours(23, 59, 59, 999);
        query = query.where("criadoEm", "<=", fim);
      }

      const snapshot = await query.get();
      lista.innerHTML = "";

      if (snapshot.empty) {
        lista.innerHTML = "<p>Nenhum relatÃ³rio encontrado.</p>";
        return;
      }

      snapshot.forEach(doc => {
        const r = doc.data();
        const dataFormatada = r.criadoEm?.toDate().toLocaleString("pt-BR") || "";
        if (clienteFiltro && !r.cliente.toLowerCase().includes(clienteFiltro)) return;

        const item = document.createElement("div");
        item.className = "bg-gray-50 p-4 border rounded shadow";

        item.innerHTML = `
          <p><b>Cliente:</b> <input value="${r.cliente}" class="border p-1 rounded w-full"></p>
          <p><b>Data:</b> <input type="date" value="${r.data}" class="border p-1 rounded"></p>
          <p><b>ServiÃ§o:</b> <textarea class="border p-1 rounded w-full">${r.servico}</textarea></p>
          <p><b>ObservaÃ§Ãµes:</b> <textarea class="border p-1 rounded w-full">${r.observacoes || ""}</textarea></p>
          <p><b>Criado em:</b> ${dataFormatada}</p>
          <button onclick='enviarWhatsapp(${JSON.stringify({
            cliente: r.cliente,
            data: r.data,
            servico: r.servico,
            observacoes: r.observacoes || "",
            criadoEm: dataFormatada
          })})' class='mt-2 bg-green-600 text-white px-4 py-1 rounded'>ğŸ“¤ Enviar por WhatsApp</button>
        `;

        lista.appendChild(item);
      });
    }

    function enviarWhatsapp(relatorio) {
      const mensagem = `
ğŸ“‹ *RelatÃ³rio TÃ©cnico*
ğŸ‘¤ Cliente: ${relatorio.cliente}
ğŸ“… Data: ${relatorio.data}
ğŸ› ï¸ ServiÃ§o: ${relatorio.servico}
ğŸ“ ObservaÃ§Ãµes: ${relatorio.observacoes}
ğŸ“Œ Criado em: ${relatorio.criadoEm}
      `.trim();

      const numero = prompt("Digite o nÃºmero do WhatsApp com DDD (ex: 21999999999):");
      if (!numero) return;

      const url = `https://wa.me/55${numero}?text=${encodeURIComponent(mensagem)}`;
      window.open(url, "_blank");
    }
  </script>
</body>
</html>
