<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor TI - Cloud Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#ef4444',
                        secondary: '#1f2937',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .card-enter { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #ef4444; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

<header class="bg-secondary text-white shadow-lg z-10">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <i class="fas fa-cloud text-primary text-2xl"></i>
            <div>
                <h1 class="text-xl font-bold tracking-wide leading-none">Gestor WG INFO</h1>
                <span class="text-xs text-gray-400 flex items-center gap-1">
                    <span id="connectionStatus" class="w-2 h-2 rounded-full bg-yellow-500"></span>
                    <span id="connectionText">Conectando...</span>
                </span>
            </div>
        </div>
    </div>
</header>

<div class="flex flex-1 overflow-hidden">
    <aside class="w-64 bg-white shadow-md flex flex-col z-0">
        <div class="p-4 border-b border-gray-200 bg-gray-50">
            <h2 class="font-semibold text-gray-700 mb-2">Clientes</h2>
            <button onclick="openAddClientModal()" class="w-full bg-secondary hover:bg-gray-800 text-white py-2 rounded text-sm transition shadow flex items-center justify-center gap-2">
                <i class="fas fa-plus"></i> Novo Cliente
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-2 space-y-1 relative" id="clientList">
            <div class="flex justify-center mt-10"><div class="loader"></div></div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col bg-gray-100 overflow-hidden relative">

        <div class="bg-white p-4 shadow-sm border-b border-gray-200 flex justify-between items-center">
            <div>
                <h2 id="currentClientTitle" class="text-2xl font-bold text-gray-800">Selecione um Cliente</h2>
                <p id="currentClientSubtitle" class="text-sm text-gray-500">Gerencie os acessos remotos</p>
            </div>

            <div id="computerActions" class="hidden flex items-center">
                <div class="relative inline-block mr-2">
                    <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                    <input type="text" id="searchInput" onkeyup="filterComputers()" placeholder="Buscar PC, Setor..." class="pl-10 pr-4 py-2 border rounded-lg text-sm w-48 md:w-64">
                </div>

                <button onclick="openAddComputerModal()" class="bg-primary hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2">
                    <i class="fas fa-laptop-medical"></i> <span class="hidden sm:inline">Adicionar PC</span>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6" id="mainContent">
            <div class="text-center text-gray-400 mt-20">
                <i class="fas fa-cloud-upload-alt text-6xl mb-4 opacity-50"></i>
                <p class="text-xl">Seus dados agora estão seguros na nuvem.</p>
                <p class="text-sm mt-2">Selecione um cliente para começar.</p>
            </div>
        </div>
    </main>
</div>

<!-- Modal Cliente -->
<div id="clientModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-96 p-6 card-enter">
        <h3 id="clientModalTitle" class="text-lg font-bold mb-4">Novo Cliente</h3>
        <input type="text" id="newClientName" placeholder="Nome da Empresa" class="w-full border p-2 rounded mb-4">
        <div class="flex justify-end gap-2">
            <button onclick="closeModal('clientModal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
            <button onclick="addClient()" id="btnSaveClient" class="px-4 py-2 bg-secondary text-white rounded hover:bg-gray-800">Salvar</button>
        </div>
    </div>
</div>

<!-- Modal PC -->
<div id="computerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 card-enter">

        <h3 id="computerModalTitle" class="text-lg font-bold mb-4 text-gray-800 border-b pb-2">Novo Computador</h3>

        <div class="grid grid-cols-2 gap-4 mb-3">
            <div>
                <label class="block text-xs font-bold">Nome do PC / Usuário</label>
                <input type="text" id="pcName" class="w-full border p-2 rounded">
            </div>

            <div>
                <label class="block text-xs font-bold">Setor</label>
                <input type="text" id="pcSetor" class="w-full border p-2 rounded">
            </div>
        </div>

        <div class="mb-3">
            <label class="block text-xs font-bold">Configuração</label>
            <input type="text" id="pcConfig" class="w-full border p-2 rounded">
        </div>

        <div class="grid grid-cols-2 gap-4 bg-red-50 p-3 rounded-lg mb-4">
            <div>
                <label class="block text-xs font-bold text-red-500">AnyDesk ID</label>
                <input type="number" id="pcAnyId" class="w-full border p-2 font-mono">
            </div>
            <div>
                <label class="block text-xs font-bold text-red-500">Senha</label>
                <input type="text" id="pcAnyPass" class="w-full border p-2 font-mono">
            </div>
        </div>

        <div class="flex justify-end gap-2">
            <button onclick="closeModal('computerModal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancelar</button>
            <button onclick="addComputer()" id="btnSavePc" class="px-4 py-2 bg-primary text-white rounded">Salvar PC</button>
        </div>
    </div>
</div>

<!-- Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
        getFirestore, collection, addDoc, deleteDoc, doc,
        onSnapshot, updateDoc, query, where, limit, getDocs
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBOc-qReOgBoDWQOYVNSlNMgRjF_hfH6uw",
        authDomain: "sistema-chamados-99e49.firebaseapp.com",
        projectId: "sistema-chamados-99e49"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = "login-tecnico.html";
        } else {
            currentUser = user;
            subscribeToData();
        }
    });

    function subscribeToData() {
        const clientsRef = collection(db, "clientes");
        const computersRef = collection(db, "computadores");

        onSnapshot(clientsRef, (snapshot) => {
            const clients = [];
            snapshot.forEach(doc => clients.push({ id: doc.id, ...doc.data() }));
            window.updateClientsList(clients);
        });

        onSnapshot(computersRef, (snapshot) => {
            const computers = [];
            snapshot.forEach(doc => computers.push({ id: doc.id, ...doc.data() }));
            window.updateComputersList(computers);
        });
    }

    window.addClient = async () => {
        const name = document.getElementById("newClientName").value;
        if (!name) return alert("Digite o nome do cliente.");

        await addDoc(collection(db, "clientes"), {
            name,
            createdAt: new Date().toISOString()
        });

        document.getElementById("newClientName").value = "";
        closeModal("clientModal");
    };

    window.addComputer = async () => {
        if (!window.selectedClientId) return alert("Selecione um cliente.");

        const name = pcName.value;
        const sector = pcSetor.value;
        const config = pcConfig.value;
        const anyId = pcAnyId.value;
        const anyPass = pcAnyPass.value;

        if (!name || !anyId) return alert("Nome e AnyDesk ID são obrigatórios.");

        await addDoc(collection(db, "computadores"), {
            clientId: window.selectedClientId,
            name, sector, config, anyId, anyPass,
            createdAt: new Date().toISOString()
        });

        closeModal("computerModal");
        ["pcName","pcSetor","pcConfig","pcAnyId","pcAnyPass"].forEach(id => document.getElementById(id).value = "");
    };

    // ====== EDIÇÃO / EXCLUSÃO (Clientes e Computadores) ======
    let editingClientId = null;
    let editingComputerId = null;

    window.openAddClientModal = () => {
        editingClientId = null;
        document.getElementById("clientModalTitle").innerText = "Novo Cliente";
        document.getElementById("newClientName").value = "";
        const btn = document.getElementById("btnSaveClient");
        btn.innerText = "Salvar";
        btn.onclick = window.addClient;
        openModal("clientModal");
    };

    window.editClient = (clientId) => {
        const client = (window.updateClientsList && window.selectedClientId !== undefined) ? null : null; // placeholder to avoid linter
        // Puxa da lista já carregada na UI (renderClients usa localData; aqui usamos o DOM como fallback)
        const found = window.__clientsCache?.find?.(c => c.id === clientId);
        const name = found?.name || "";
        editingClientId = clientId;
        document.getElementById("clientModalTitle").innerText = "Editar Empresa";
        document.getElementById("newClientName").value = name;
        const btn = document.getElementById("btnSaveClient");
        btn.innerText = "Salvar alterações";
        btn.onclick = window.saveClientEdit;
        openModal("clientModal");
    };

    window.saveClientEdit = async () => {
        if (!editingClientId) return;
        const name = document.getElementById("newClientName").value.trim();
        if (!name) return alert("Digite o nome da empresa.");
        await updateDoc(doc(db, "clientes", editingClientId), { name, updatedAt: new Date().toISOString() });
        closeModal("clientModal");
        editingClientId = null;
    };

    window.deleteClient = async (clientId) => {
        // Opção 2: bloquear exclusão se tiver PCs
        const pcsQ = query(collection(db, "computadores"), where("clientId", "==", clientId), limit(1));
        const pcsSnap = await getDocs(pcsQ);
        if (!pcsSnap.empty) {
            return alert("Não dá pra excluir: essa empresa tem computadores cadastrados. Apague/realocar os PCs primeiro.");
        }
        if (!confirm("Excluir esta empresa? Essa ação não pode ser desfeita.")) return;
        await deleteDoc(doc(db, "clientes", clientId));
        if (window.selectedClientId === clientId) {
            window.selectedClientId = null;
        }
    };

    window.openAddComputerModal = () => {
        if (!window.selectedClientId) return alert("Selecione um cliente.");
        editingComputerId = null;
        document.getElementById("computerModalTitle").innerText = "Novo Computador";
        const btn = document.getElementById("btnSavePc");
        btn.innerText = "Salvar PC";
        btn.onclick = window.addComputer;

        ["pcName","pcSetor","pcConfig","pcAnyId","pcAnyPass"].forEach(id => document.getElementById(id).value = "");
        openModal("computerModal");
    };

    window.editComputer = (pcId) => {
        const found = window.__computersCache?.find?.(p => p.id === pcId);
        if (!found) return alert("Computador não encontrado na lista.");
        editingComputerId = pcId;

        document.getElementById("computerModalTitle").innerText = "Editar Computador";
        document.getElementById("pcName").value = found.name || "";
        document.getElementById("pcSetor").value = found.sector || "";
        document.getElementById("pcConfig").value = found.config || "";
        document.getElementById("pcAnyId").value = found.anyId || "";
        document.getElementById("pcAnyPass").value = found.anyPass || "";

        const btn = document.getElementById("btnSavePc");
        btn.innerText = "Salvar alterações";
        btn.onclick = window.saveComputerEdit;

        openModal("computerModal");
    };

    window.saveComputerEdit = async () => {
        if (!editingComputerId) return;
        const name = document.getElementById("pcName").value.trim();
        const sector = document.getElementById("pcSetor").value.trim();
        const config = document.getElementById("pcConfig").value.trim();
        const anyId = document.getElementById("pcAnyId").value.toString().trim();
        const anyPass = document.getElementById("pcAnyPass").value.trim();

        if (!name || !anyId) return alert("Nome e AnyDesk ID são obrigatórios.");
        await updateDoc(doc(db, "computadores", editingComputerId), {
            name, sector, config, anyId, anyPass,
            updatedAt: new Date().toISOString()
        });
        closeModal("computerModal");
        editingComputerId = null;
    };

    window.deleteComputer = async (pcId) => {
        if (!confirm("Excluir este computador?")) return;
        await deleteDoc(doc(db, "computadores", pcId));
    };


</script>

<script>
    let localData = { clients: [], computers: [] };
    window.selectedClientId = null;

    window.updateClientsList = (clients) => {
        localData.clients = clients;
        window.__clientsCache = clients;
        renderClients();
    };

    window.updateComputersList = (computers) => {
        localData.computers = computers;
        window.__computersCache = computers;
        if (window.selectedClientId) renderComputers();
    };

    function renderClients() {
        const list = document.getElementById("clientList");
        list.innerHTML = "";

        if (localData.clients.length === 0) {
            list.innerHTML = '<div class="text-center text-gray-400 mt-4">Nenhum cliente.</div>';
            return;
        }

        localData.clients.forEach(client => {
            const row = document.createElement("div");
            row.className = "w-full flex items-center justify-between px-3 py-2 rounded mb-1 hover:bg-gray-100 border border-transparent hover:border-gray-200";

            const nameBtn = document.createElement("button");
            nameBtn.className = "flex-1 text-left pr-2";
            nameBtn.innerHTML = `<span class="font-medium text-gray-800">${client.name}</span>`;
            nameBtn.onclick = () => selectClient(client.id);

            const actions = document.createElement("div");
            actions.className = "flex items-center gap-2";

            const editBtn = document.createElement("button");
            editBtn.className = "text-gray-500 hover:text-gray-900 px-2 py-1 rounded";
            editBtn.title = "Editar empresa";
            editBtn.innerHTML = '<i class="fas fa-pen"></i>';
            editBtn.onclick = (e) => { e.stopPropagation(); window.editClient(client.id); };

            const delBtn = document.createElement("button");
            delBtn.className = "text-red-500 hover:text-red-700 px-2 py-1 rounded";
            delBtn.title = "Excluir empresa";
            delBtn.innerHTML = '<i class="fas fa-trash"></i>';
            delBtn.onclick = (e) => { e.stopPropagation(); window.deleteClient(client.id); };

            actions.appendChild(editBtn);
            actions.appendChild(delBtn);

            row.appendChild(nameBtn);
            row.appendChild(actions);
            list.appendChild(row);
        });
    }

    function selectClient(id) {
        window.selectedClientId = id;
        const client = localData.clients.find(c => c.id === id);

        currentClientTitle.innerText = client.name;
        currentClientSubtitle.innerText = "Computadores cadastrados";

        document.getElementById("computerActions").classList.remove("hidden");

        renderComputers();
    }

    function renderComputers() {
        const container = document.getElementById("mainContent");

        const list = localData.computers.filter(pc => pc.clientId === window.selectedClientId);

        if (list.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-400 mt-10">Nenhum computador para este cliente.</div>`;
            return;
        }

        container.innerHTML =
            `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${list.map(pc => `
                <div class="bg-white rounded-lg shadow p-4 border">
                    <h4 class="font-bold text-gray-800 text-lg">${pc.name}</h4>
                    <p class="text-gray-500 text-sm">${pc.sector}</p>
                    <p class="text-xs mt-2">${pc.config}</p>
                    <div class="bg-gray-50 p-2 mt-3 rounded">
                        <strong>ID:</strong> ${pc.anyId}
                    </div>
                    <div class="bg-gray-50 p-2 mt-2 rounded">
                        <strong>Senha:</strong> ${pc.anyPass}
                    </div>

                    <div class="flex justify-end gap-2 mt-3">
                        <button class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm" onclick="editComputer('${pc.id}')">
                            <i class="fas fa-pen"></i> Editar
                        </button>
                        <button class="px-3 py-1 rounded bg-red-50 hover:bg-red-100 text-red-700 text-sm" onclick="deleteComputer('${pc.id}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </div>
                </div>`).join("")}
            </div>`;
    }

    function filterComputers() {
        renderComputers();
    }

    function openModal(id) {
        document.getElementById(id).classList.remove("hidden");
    }

    function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
    }
</script>

</body>
</html>
