<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Técnico - WG Informática</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen">

    <header class="bg-slate-800 shadow-md">
        <div class="max-w-4xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">Relatório Técnico</h1>
            <a href="tecnico.html" class="text-sm text-teal-400 hover:text-teal-300">← Voltar ao Painel</a>
        </div>
    </header>

    <main class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="bg-slate-800 rounded-2xl shadow-2xl p-8 border border-slate-700">
            <form id="form-relatorio" class="space-y-4">
                <input id="cliente" class="w-full p-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Cliente" required>
                <input id="data" type="date" class="w-full p-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                <textarea id="servico" class="w-full p-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-teal-500 h-24" placeholder="Serviço Executado" required></textarea>
                
                <!-- Assistente de IA Gemini -->
                <div class="p-4 bg-slate-700/50 rounded-lg border border-slate-600">
                    <label for="gemini-prompt" class="block text-sm font-medium text-teal-400 mb-2">✨ Assistente de Relatório IA</label>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="gemini-prompt" placeholder="Digite palavras-chave (ex: troca HD, backup, windows)" class="flex-grow p-2 rounded-lg bg-slate-600 text-white border border-slate-500 focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <button type="button" onclick="gerarRelatorioIA()" class="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-500 transition-colors">Gerar Texto</button>
                    </div>
                     <p id="gemini-loading" class="text-sm text-slate-400 mt-2 hidden">Gerando texto com IA...</p>
                </div>

                <input id="tecnico" class="w-full p-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Técnico Responsável" required>
                <textarea id="observacoes" class="w-full p-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-teal-500 h-24" placeholder="Observações"></textarea>
                <input id="numeroZap" class="w-full p-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Número do WhatsApp (ex: 5521999999999)" required>
                
                 <!-- Campo de Assinatura -->
                <div class="space-y-2">
                    <label for="assinaturaCliente" class="block text-sm font-medium text-slate-300">Assinatura do Cliente:</label>
                    <canvas id="assinaturaCliente" class="bg-white rounded-lg border-2 border-slate-600 w-full h-32 cursor-crosshair"></canvas>
                    <button type="button" onclick="limparAssinatura()" class="bg-slate-600 text-white text-sm font-semibold py-1 px-3 rounded-lg hover:bg-slate-500 transition-colors">Limpar Assinatura</button>
                </div>

                <div class="flex flex-col sm:flex-row gap-2 pt-4">
                    <button type="submit" class="w-full sm:w-auto flex-1 bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-500 transition-colors">Salvar e Enviar WhatsApp</button>
                    <button type="button" onclick="gerarPDF()" class="w-full sm:w-auto flex-1 bg-sky-600 text-white font-semibold py-3 rounded-lg hover:bg-sky-500 transition-colors">Gerar PDF</button>
                </div>
            </form>
        </div>
    </main>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const db = firebase.firestore();
        const auth = firebase.auth();
        const apiKey = "AIzaSyALJ6CJjviy4JFaxUAhbldZRrdd99twvSE"; // Sua chave de API aqui

        // --- Lógica do Canvas de Assinatura ---
        const canvas = document.getElementById("assinaturaCliente");
        const ctx = canvas.getContext("2d");
        let desenhando = false;

        function getPos(canvasDom, event) {
            const rect = canvasDom.getBoundingClientRect();
            return {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            };
        }

        function getTouchPos(canvasDom, touchEvent) {
            const rect = canvasDom.getBoundingClientRect();
            return {
                x: touchEvent.touches[0].clientX - rect.left,
                y: touchEvent.touches[0].clientY - rect.top
            };
        }

        canvas.addEventListener("mousedown", (e) => {
            desenhando = true;
            const pos = getPos(canvas, e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        });
        canvas.addEventListener("mouseup", () => { desenhando = false; });
        canvas.addEventListener("mousemove", (e) => {
            if (!desenhando) return;
            const pos = getPos(canvas, e);
            ctx.lineWidth = 2;
            ctx.lineCap = "round";
            ctx.strokeStyle = "#334155";
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        });
        // Touch events
        canvas.addEventListener("touchstart", (e) => {
            desenhando = true;
            const pos = getTouchPos(canvas, e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        });
        canvas.addEventListener("touchend", () => { desenhando = false; });
        canvas.addEventListener("touchmove", (e) => {
            if (!desenhando) return;
            e.preventDefault(); // Evita scroll da página
            const pos = getTouchPos(canvas, e);
            ctx.lineWidth = 2;
            ctx.lineCap = "round";
            ctx.strokeStyle = "#334155";
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        });


        function limparAssinatura() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function isCanvasBlank(canvas) {
            const context = canvas.getContext('2d');
            const pixelBuffer = new Uint32Array(
                context.getImageData(0, 0, canvas.width, canvas.height).data.buffer
            );
            return !pixelBuffer.some(color => color !== 0);
        }

        // --- Lógica do Firebase e Formulário ---
        auth.onAuthStateChanged(user => {
            if (!user) return location.href = "login-tecnico.html";
            document.getElementById('tecnico').value = user.email;
        });

        document.getElementById("form-relatorio").addEventListener("submit", async (e) => {
            e.preventDefault();
            const cliente = document.getElementById("cliente").value;
            const data = document.getElementById("data").value;
            const servico = document.getElementById("servico").value;
            const tecnico = document.getElementById("tecnico").value;
            const observacoes = document.getElementById("observacoes").value;
            const numero = document.getElementById("numeroZap").value;
            const assinaturaDataUrl = isCanvasBlank(canvas) ? null : canvas.toDataURL('image/png');
            
            const relatorioId = db.collection("relatorios_tecnicos").doc().id;

            const dataRelatorio = {
                id: relatorioId,
                cliente, data, servico, tecnico, observacoes,
                assinatura: assinaturaDataUrl,
                usuarioId: auth.currentUser.uid,
                criadoEm: firebase.firestore.Timestamp.fromDate(new Date())
            };

            try {
                await db.collection("relatorios_tecnicos").doc(relatorioId).set(dataRelatorio);
                let texto = `*RELATÓRIO TÉCNICO*\n\n*Cliente:* ${cliente}\n*Data:* ${new Date(data + 'T00:00:00').toLocaleDateString('pt-BR')}\n*Serviço:* ${servico}\n*Técnico:* ${tecnico}\n*Observações:* ${observacoes}`;
                if(assinaturaDataUrl) {
                    texto += `\n\n*Relatório assinado pelo cliente.*`;
                }
                const url = `https://wa.me/${numero}?text=${encodeURIComponent(texto)}`;
                window.open(url, '_blank');
                alert("Relatório salvo e WhatsApp aberto!");
                document.getElementById("form-relatorio").reset();
                limparAssinatura();
                document.getElementById('tecnico').value = auth.currentUser.email;
            } catch (error) {
                console.error("Erro ao salvar no Firebase:", error);
                alert("Erro ao salvar o relatório.");
            }
        });

        async function gerarRelatorioIA() {
            const prompt = document.getElementById('gemini-prompt').value;
            const loading = document.getElementById('gemini-loading');
            const servicoTextarea = document.getElementById('servico');

            if (!prompt) {
                alert('Por favor, digite algumas palavras-chave sobre o serviço.');
                return;
            }
             if (!apiKey) {
                alert('A chave da API Gemini não está configurada.');
                return;
            }

            loading.classList.remove('hidden');
            servicoTextarea.value = 'Gerando...';

            try {
                const systemPrompt = "Você é um assistente de TI. Com base nas palavras-chave fornecidas, escreva um parágrafo claro e profissional para um relatório técnico destinado a um cliente. Descreva o serviço realizado de forma concisa e educada.";
                const userQuery = prompt;
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.statusText}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    servicoTextarea.value = candidate.content.parts[0].text;
                } else {
                    throw new Error("Resposta da API inválida.");
                }

            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                servicoTextarea.value = `Erro ao gerar texto: ${error.message}`;
                alert("Não foi possível gerar o relatório com a IA. Verifique sua chave de API e a conexão.");
            } finally {
                loading.classList.add('hidden');
            }
        }

        function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 15;

            // Cabeçalho
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text("WG INFORMATICA SUPORTE E MANUTENÇÃO DE COMPUTADORES", 105, y, { align: 'center' });
            y += 7;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text("CNPJ: 18.227.202/0001-36", 105, y, { align: 'center' });
            y += 5;
            doc.text("Rua Doutor Feliciano Sodré, Nº 182, Sala 301, Centro, São Gonçalo - RJ - CEP: 24.440-440", 105, y, { align: 'center' });
            y += 8;
            doc.setLineWidth(0.5);
            doc.line(15, y, 195, y);
            y += 12;

            // Título
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text("RELATÓRIO TÉCNICO", 15, y);
            y += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);

            // Dados do formulário
            const cliente = document.getElementById("cliente").value;
            const data = new Date(document.getElementById("data").value + 'T00:00:00').toLocaleDateString('pt-BR');
            const servico = document.getElementById("servico").value;
            const tecnico = document.getElementById("tecnico").value;
            const observacoes = document.getElementById("observacoes").value;

            doc.text(`Cliente: ${cliente}`, 15, y); y += 7;
            doc.text(`Data: ${data}`, 15, y); y += 7;
            doc.text(`Técnico: ${tecnico}`, 15, y); y += 12;

            doc.setFont('helvetica', 'bold');
            doc.text("Serviço Executado:", 15, y); y += 6;
            doc.setFont('helvetica', 'normal');
            const servicoLines = doc.splitTextToSize(servico, 180);
            doc.text(servicoLines, 15, y);
            y += servicoLines.length * 5 + 8;

            if (observacoes) {
                doc.setFont('helvetica', 'bold');
                doc.text("Observações:", 15, y); y += 6;
                doc.setFont('helvetica', 'normal');
                const obsLines = doc.splitTextToSize(observacoes, 180);
                doc.text(obsLines, 15, y);
                y += obsLines.length * 5 + 8;
            }

            // Adiciona a assinatura se não estiver em branco
            if (!isCanvasBlank(canvas)) {
                y += 10;
                const signatureData = canvas.toDataURL("image/png");
                doc.addImage(signatureData, "PNG", 15, y, 70, 25);
                y += 30;
                doc.line(15, y, 85, y);
                y += 5;
                doc.text("Assinatura do Cliente", 15, y);
            }
            
            doc.save(`relatorio_${cliente.replace(/\s+/g, '_')}.pdf`);
        }
    </script>

</body>
</html>

